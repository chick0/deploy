{% extends "layout.jinja2" %}
{% block content %}
<div class="section">
    <div class="container">
        <h1 class="title is-1 has-text-centered">배포 토큰 테스트</h1>
        <div class="box">
            <div class="field">
                <label class="label">프로젝트 이름</label>
                <div class="control has-icons-left">
                    <input class="input" type="text" placeholder="프로젝트 이름" id="x-deploy-name">
                    <span class="icon is-small is-left">
                        <i class="fas fa-file"></i>
                    </span>
                </div>
            </div>

            <div class="field">
                <label class="label">배포 토큰</label>
                <div class="control has-icons-left">
                    <input class="input" type="password" placeholder="배포 토큰" id="x-deploy-token">
                    <span class="icon is-small is-left">
                        <i class="fas fa-key"></i>
                    </span>
                </div>
            </div>
            <hr>
            <div class="buttons">
                <button class="button is-link is-fullwidth tk-test">테스트</button>
            </div>
        </div>
    </div>
</div>

<script>
    function get_value(element_id) {
        return document.getElementById(element_id).value;
    }

    const button = document.querySelector("button.tk-test");

    button.addEventListener("click", () => {
        if (button.classList.contains("is-loading")) {
            alert("이미 프로젝트 정보를 불러오고 있습니다. 잠시만 기다려주세요.");
            return;
        }

        button.classList.add("is-loading");

        fetch("/api/token/test", {
            method: "POST",
            headers: {
                "x-deploy-name": get_value("x-deploy-name"),
                "x-deploy-token": get_value("x-deploy-token"),
            },
        })
            .then((resp) => resp.json())
            .then((json) => {
                alert(json.message);
                button.classList.remove("is-loading");
            }).catch(() => {
                alert("토큰을 테스트하는 과정에서 알 수 없는 오류가 발생했습니다.");
                button.classList.remove("is-loading");
            });
    });
</script>
{% endblock %}